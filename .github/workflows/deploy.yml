#!/bin/bash
set -e  # Exit immediately if a command fails

echo "==== Retrain started at $(date) ===="

# Absolute paths
PROJECT_DIR="/home/ec2-user/app/ml"
VENV_DIR="$PROJECT_DIR/.venv"
LOG_FILE="$PROJECT_DIR/retrain.log"

# S3 bucket
S3_BUCKET="rain-predictor-ml-data"

# Cities to predict
CITIES=("Miami" "Orlando" "Tampa" "Jacksonville" "Fort Lauderdale")

# Ensure project directory exists
cd $PROJECT_DIR || { echo "Project directory not found: $PROJECT_DIR"; exit 1; }

# Create virtual environment if it doesn't exist
if [ ! -d "$VENV_DIR" ]; then
    echo "⏳ Creating virtual environment..."
    python3 -m venv $VENV_DIR
fi

# Activate virtual environment
source $VENV_DIR/bin/activate

# Upgrade pip and install requirements
pip install --upgrade pip
pip install -r "$PROJECT_DIR/requirements.txt"

# Loop through cities for data ingestion
for CITY in "${CITIES[@]}"; do
    echo "⏳ Ingesting data for $CITY..."
    python3 backend/ingest.py --city "$CITY" >> "$LOG_FILE" 2>&1
done

# Train the model
echo "⏳ Training model..."
python3 backend/train.py >> "$LOG_FILE" 2>&1

# Upload CSV and model to S3
echo "⏳ Uploading files to S3..."
aws s3 cp "$PROJECT_DIR/data.csv" "s3://$S3_BUCKET/data.csv" >> "$LOG_FILE" 2>&1
aws s3 cp "$PROJECT_DIR/rain_model.pkl" "s3://$S3_BUCKET/rain_model.pkl" >> "$LOG_FILE" 2>&1

echo "==== Retrain completed at $(date) ===="